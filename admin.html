<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZERO Admin â€” Advanced Dashboard</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0c0c0c;
            --sidebar-bg: #111111;
            --card-bg: #181818;
            --text-color: #ffffff;
            --accent-color: #00ff88;
            --border-color: #222222;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 3rem;
            letter-spacing: -1px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--card-bg);
            color: var(--text-color);
        }

        .main-content {
            flex: 1;
            padding: 2.5rem;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }

        #login-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-box {
            background: var(--sidebar-bg);
            padding: 3rem;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 1rem;
            margin: 10px 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: #fff;
            font-family: inherit;
        }

        .btn {
            padding: 1rem 2rem;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 10px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn-danger {
            background: #ff3e3e;
            color: #fff;
        }

        /* Product Variant Styles */
        .variant-card {
            background: #222;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-color);
        }

        .price-tag {
            font-weight: 800;
        }

        .price-old {
            text-decoration: line-through;
            opacity: 0.4;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .order-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1rem;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 800;
        }

        .tag-pending {
            background: #ffd900;
            color: #000;
        }

        .tag-shipped {
            background: #0077ff;
            color: #fff;
        }
    </style>
</head>

<body>
    <div id="login-overlay">
        <div class="login-box">
            <h2>ZERO ADMIN</h2>
            <p style="opacity: 0.5;">Access Secure Portal</p>
            <input type="email" id="admin-email" placeholder="Email Address">
            <input type="password" id="admin-pass" placeholder="Password">
            <button id="admin-login-btn" class="btn" style="width:100%">LOGIN</button>
        </div>
    </div>

    <aside class="sidebar" style="display: none;">
        <div class="sidebar-logo">ZERO<span>.</span></div>
        <nav>
            <div class="nav-item active" data-view="overview"><i data-lucide="layout-dashboard"></i> Overview</div>
            <div class="nav-item" data-view="products"><i data-lucide="package"></i> Products</div>
            <div class="nav-item" data-view="orders"><i data-lucide="shopping-cart"></i> Orders</div>
            <div class="nav-item" data-view="shipping"><i data-lucide="truck"></i> Shipping</div>
            <div class="nav-item" data-view="management"><i data-lucide="users"></i> Management</div>
        </nav>
        <div style="margin-top: auto;">
            <div class="nav-item" id="admin-logout"><i data-lucide="log-out"></i> Logout</div>
        </div>
    </aside>

    <main class="main-content" style="display: none;">
        <div id="view-content">
            <!-- Overview (Default) -->
            <div class="header">
                <h1>Dashboard Overview</h1>
                <div id="user-tag" style="opacity:0.5"></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Revenue</h3>
                    <div class="value" id="stat-revenue">0 EGP</div>
                </div>
                <div class="stat-card">
                    <h3>Total Orders</h3>
                    <div class="value" id="stat-orders-count">0</div>
                </div>
                <div class="stat-card">
                    <h3>Products</h3>
                    <div class="value" id="stat-products-count">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Visitors</h3>
                    <div class="value" id="stat-visitors-count">0</div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDKHMmR-Jl9JbqEZtS58XgM42pFftepNb4",
            authDomain: "m989-5f329.firebaseapp.com",
            projectId: "m989-5f329",
            storageBucket: "m989-5f329.firebasestorage.app",
            messagingSenderId: "617175385217",
            appId: "1:617175385217:web:2ace1f8e6db4287376f980",
            measurementId: "G-D8PYFFX4RN"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const loginOverlay = document.getElementById('login-overlay');
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');
        const viewContent = document.getElementById('view-content');

        // Auth Login
        document.getElementById('admin-login-btn').onclick = async () => {
            const e = document.getElementById('admin-email').value;
            const p = document.getElementById('admin-pass').value;
            try { await signInWithEmailAndPassword(auth, e, p); } catch (err) { alert(err.message); }
        };

        document.getElementById('admin-logout').onclick = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "admins", user.email));
                if (snap.exists()) {
                    loginOverlay.style.display = 'none';
                    sidebar.style.display = 'flex';
                    mainContent.style.display = 'block';
                    document.getElementById('user-tag').innerText = `${snap.data().role}: ${user.email}`;
                    loadGlobalStats();
                } else { alert("Unauthorized"); signOut(auth); }
            } else {
                loginOverlay.style.display = 'flex';
                sidebar.style.display = 'none';
                mainContent.style.display = 'none';
            }
        });

        function loadGlobalStats() {
            onSnapshot(collection(db, "products"), s => document.getElementById('stat-products-count').innerText = s.size);
            onSnapshot(collection(db, "orders"), s => document.getElementById('stat-orders-count').innerText = s.size);
            onSnapshot(doc(db, "stats", "counters"), s => {
                if (s.exists()) document.getElementById('stat-visitors-count').innerText = s.data().total_visitors || 0;
            });
        }

        // Navigation View Linker
        document.querySelectorAll('.nav-item').forEach(item => {
            item.onclick = () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                const view = item.dataset.view;
                if (view === 'products') renderProductsView();
                else if (view === 'orders') renderOrdersView();
                else if (view === 'shipping') renderShippingView();
                else if (view === 'management') renderManagementView();
                else window.location.reload();
            }
        });

        // --- PRODUCTS VIEW ---
        async function renderProductsView() {
            viewContent.innerHTML = `
            <div class="header"><h1>Product Management</h1><button id="btn-add-p" class="btn">+ NEW PRODUCT</button></div>
            <div id="p-add-form" style="display:none; background:var(--sidebar-bg); padding:2rem; border-radius:20px; border:1px solid var(--border-color); margin-bottom:2.5rem;">
                <h3>New Product Details</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <input id="p-name" placeholder="Product Name">
                    <select id="p-cat"><option value="Essential">Essential Collection</option><option value="Limited">Limited Edition</option></select>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <input id="p-price-old" type="number" placeholder="Old Price (e.g. 1500)">
                    <input id="p-price-now" type="number" placeholder="Sale Price (e.g. 990)">
                </div>
                <div id="variants-container">
                    <p style="opacity:0.5; margin-top:20px;">Colors & Sizes</p>
                    <div class="variant-card">
                        <input class="v-color" placeholder="Color Name (e.g. Midnight Black)">
                        <input class="v-sizes" placeholder="Sizes (e.g. S, M, L, XL)">
                        <input type="file" class="v-images" multiple accept="image/*">
                    </div>
                </div>
                <button id="btn-add-variant" class="btn" style="background:transparent; color:#fff; border:1px solid #333; margin-bottom:20px;">+ ADD ANOTHER COLOR</button>
                <button id="btn-save-product" class="btn" style="width:100%">PUBLISH TO STORE</button>
            </div>
            <div id="p-list-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:20px;">Loading...</div>
        `;

            const pForm = document.getElementById('p-add-form');
            document.getElementById('btn-add-p').onclick = () => pForm.style.display = 'block';

            document.getElementById('btn-add-variant').onclick = () => {
                const div = document.createElement('div');
                div.className = "variant-card";
                div.innerHTML = `<input class="v-color" placeholder="Color Name"><input class="v-sizes" placeholder="Sizes (S, M, L)"><input type="file" class="v-images" multiple accept="image/*">`;
                document.getElementById('variants-container').appendChild(div);
            };

            // Real-time List
            onSnapshot(collection(db, "products"), snap => {
                const list = document.getElementById('p-list-grid');
                list.innerHTML = snap.docs.map(doc => {
                    const p = doc.data();
                    return `
                    <div class="order-card" style="text-align:center;">
                        <img src="${p.mainImage || ''}" style="width:100%; height:200px; object-fit:cover; border-radius:10px; background:#000;">
                        <h4 style="margin:15px 0 5px">${p.name}</h4>
                        <p class="price-tag"><span class="price-old">${p.priceOld} EGP</span> ${p.priceNow} EGP</p>
                        <button class="btn-danger" style="margin-top:10px; width:100%; border-radius:5px; padding:8px;" onclick="deleteProduct('${doc.id}')">Delete</button>
                    </div>
                `;
                }).join('');
            });

            document.getElementById('btn-save-product').onclick = async () => {
                const n = document.getElementById('p-name').value;
                const po = document.getElementById('p-price-old').value;
                const pn = document.getElementById('p-price-now').value;
                const cat = document.getElementById('p-cat').value;
                const vCards = document.querySelectorAll('.variant-card');

                if (!n || !pn) return alert("Missing basic info");

                const variations = [];
                let mainImgUrl = "";

                for (let card of vCards) {
                    const color = card.querySelector('.v-color').value;
                    const sizes = card.querySelector('.v-sizes').value.split(',').map(s => s.trim());
                    const files = card.querySelector('.v-images').files;
                    const imgUrls = [];

                    for (let file of files) {
                        const sRef = ref(storage, `products/${Date.now()}_${file.name}`);
                        await uploadBytes(sRef, file);
                        const url = await getDownloadURL(sRef);
                        if (!mainImgUrl) mainImgUrl = url;
                        imgUrls.push(url);
                    }
                    variations.push({ color, sizes, images: imgUrls });
                }

                await addDoc(collection(db, "products"), {
                    name: n, priceOld: po, priceNow: pn, category: cat, variants: variations, mainImage: mainImgUrl, createdAt: new Date()
                });
                alert("Product Live on Store!");
                pForm.style.display = 'none';
            };
        }

        // --- ORDERS VIEW ---
        async function renderOrdersView() {
            viewContent.innerHTML = `<div class="header"><h1>Customer Orders</h1></div><div id="orders-list">Loading...</div>`;
            onSnapshot(collection(db, "orders"), snap => {
                document.getElementById('orders-list').innerHTML = snap.docs.map(doc => {
                    const o = doc.data();
                    return `
                    <div class="order-card">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>Order #${doc.id.slice(0, 5)}</strong>
                            <span class="tag tag-pending">${o.status || 'Pending'}</span>
                        </div>
                        <p style="margin:10px 0; opacity:0.8;">Items: ${o.items?.length || 0} | Total: ${o.totalAmount} EGP</p>
                        <p style="font-size:0.8rem; opacity:0.5;">Customer: ${o.customerName} - ${o.phone}</p>
                    </div>
                `;
                }).join('');
            });
        }

        // --- SHIPPING VIEW ---
        async function renderShippingView() {
            const provinces = ["Cairo", "Giza", "Alexandria", "Dakahlia", "Sharqia", "Gharbia", "Monufia", "Beheira", "Kafr El Sheikh", "Damietta", "Port Said", "Ismailia", "Suez", "North Sinai", "South Sinai", "Beni Suef", "Fayoum", "Minya", "Assiut", "Sohag", "Qena", "Luxor", "Aswan", "Red Sea", "New Valley", "Matrouh"];
            const snap = await getDoc(doc(db, "settings", "shipping_rates"));
            const rates = snap.exists() ? snap.data() : {};

            viewContent.innerHTML = `
            <div class="header"><h1>Shipping Control</h1><button id="btn-save-ship" class="btn">SAVE ALL</button></div>
            <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                ${provinces.map(p => `
                    <div style="background:var(--card-bg); padding:1rem; border-radius:10px;">
                        <label style="font-size:0.8rem; opacity:0.6;">${p}</label>
                        <input type="number" class="ship-val" data-p="${p}" value="${rates[p] || 0}" style="margin:0">
                    </div>
                `).join('')}
            </div>
        `;
            document.getElementById('btn-save-ship').onclick = async () => {
                const newRates = {};
                document.querySelectorAll('.ship-val').forEach(i => newRates[i.dataset.p] = i.value);
                await setDoc(doc(db, "settings", "shipping_rates"), newRates);
                alert("Updated!");
            };
        }

        // --- MANAGEMENT VIEW ---
        async function renderManagementView() {
            viewContent.innerHTML = `
            <div class="header"><h1>Staff Management</h1><button id="btn-add-staff" class="btn">+ NEW STAFF</button></div>
            <div id="staff-form" style="display:none; background:var(--sidebar-bg); padding:2rem; border-radius:20px; border:1px solid var(--border-color); margin-bottom:2.5rem;">
                <input id="s-email" placeholder="Staff Email">
                <input id="s-pass" type="password" placeholder="Temporal Password">
                <select id="s-role"><option value="admin">Administrator (Global Access)</option><option value="employee">Employee (Limited)</option></select>
                <button id="btn-save-staff" class="btn" style="width:100%">CREATE ACCOUNT</button>
            </div>
            <div id="staff-list">Loading...</div>
        `;
            document.getElementById('btn-add-staff').onclick = () => document.getElementById('staff-form').style.display = 'block';

            onSnapshot(collection(db, "admins"), snap => {
                document.getElementById('staff-list').innerHTML = snap.docs.map(doc => `
                <div class="order-card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div><strong>${doc.id}</strong><br><span style="opacity:0.4">${doc.data().role}</span></div>
                    <button class="btn-danger" style="padding:5px 15px;" onclick="deleteStaff('${doc.id}')">Remove</button>
                </div>
            `).join('');
            });

            document.getElementById('btn-save-staff').onclick = async () => {
                const e = document.getElementById('s-email').value;
                const p = document.getElementById('s-pass').value;
                const r = document.getElementById('s-role').value;
                if (!e || !p) return;
                // Manual check: In a real app, use Admin API. For now, we save it to DB. 
                // Staff should try to login directly after this.
                await setDoc(doc(db, "admins", e), { role: r, email: e });
                alert("Staff added. They must now use their email/pass to login.");
                document.getElementById('staff-form').style.display = 'none';
            };
        }

        // Exposed Functions for Dynamic UI
        window.deleteProduct = async (id) => { if (confirm("Delete this?")) await deleteDoc(doc(db, "products", id)); };
        window.deleteStaff = async (id) => { if (confirm("Remove access for this staff?")) await deleteDoc(doc(db, "admins", id)); };

        lucide.createIcons();
    </script>
</body>

</html>